---
title: "GangEpl_Prelim_Analysis_Report"
author: "Jimmy Zhang"
date: "11/24/2020"
output:
  word_document: default
  pdf_document: default
  html_document:
    df_print: paged
---

TODO

- [ ] Separate Gang Activity (`GangInv2`) and Days With Gang (`GangInv1`)
- [ ] Replace the original analyses with `GangInv`
- [ ] Use employment as predictor rather than outcome. See Table 3 of the paper.

[ML]: # (You can control the global chunk options below)

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = TRUE)
```

[ML]: # (Please only use 'cache=TRUE' for long processes. It's dangerous to accumulate old data.)

```{r load packages, results = 'hide'}
options(width = 60)
library(psych)  # for scatterplot matrix
library(here)  # makes reading data more consistent
library(tidyverse)  # for data manipulation and plotting
library(modelsummary)  # for making tables
library(brms)  # for Bayesian multilevel analysis
library(sjPlot)  # for plotting slopes
library(interactions)  # for plotting interactions
library(haven)  # for importing SPSS/SAS/Stata data
library(lme4)  # for multilevel analysis
library(lattice)  # for dotplot (working with lme4)
library(MuMIn)  # for computing r-squared
library(broom.mixed)  # for summarizing results
library(funModeling)
library(Hmisc)
library(ggplot2)
library(dplyr)
msummary_mixed <- function(models, coef_map = NULL, add_rows = NULL, ...) {
  if (is.null(coef_map)) {
    if (!"list" %in% class(models)) {
      models <- list(models)
    }
    for (model in models) {
      coef_map <- union(coef_map, tidy(model)$term)
    }
  }
  ranef_index <- grep("^(sd|cor)__", x = coef_map)
  coef_map <- c(coef_map[-ranef_index], coef_map[ranef_index])
  names(coef_map) <- coef_map
  rows <- data.frame(term = c("Fixed Effects", "Random Effects"))
  rows <- cbind(rows, rbind(rep("", length(models)), 
                            rep("", length(models))))
  length_fes <- length(coef_map) - length(ranef_index)
  attr(rows, 'position') <- c(1, (length_fes + 1) * 2)
  modelsummary::msummary(models, coef_map = coef_map, add_rows = rows, ...)
}
theme_set(theme_bw())  # Theme; just my personal preference
```

[ML]: # (Please only use 'cache=TRUE' for long processes)

```{r import data}
GangEpl <- read_sav(
  here("data/Weekly Data Final Version Missing Data Addressed-12-23-09.sav")
)
GangEpl
```

# An overview of the study design and variables in the GangEpl (Gang Employment) dataset:

  This is a long form dataset in which each participant was measured multiple times (indicated by the variable Session). We have 337 observations and 57 variables in total.
  
  Within-subject design: Youth were randomly assigned to either BEP or usual services (US), and data were collected at each intervention session. Hypothesis: Increases in employment among BEP participants would be related to reductions in gang involvement over the course of treatment.
  
  Between-subject design: Compare BEP and US participants at the 3 month and 6 month assessment periods. Hypothesis: BEP would lead to higher employment and less gang involvement than US, and that changes in employment would mediate the effect of treatment on gang involvement.
  
  Variables:
  
- ID -> Pariticipant ID
- Age -> The age of participant at each session
- Session -> Time point at which each participant was recorded
- Date -> The date is in year-month-date format (read in haven package)
- EmployHrs -> The hours of working in the current week
- EmployWg -> Hourly wage in the current week
- Del -> Participants' report on the number of gang activities such as stealing over the previous week
- GangInv1 to GangInv4 -> Participants' report on questions about the level of Gang Involvment
- GangMem1 to GangMem15 -> Participants' report on Gang Membership Inventory (the measure of gang membership)
- DC1 to DC12 -> Dummy coded variables for each participant (In the draft paper, the author stated that to identify sources of contamination expected from pooling data from multiple participants, a least squares with dummy variables (LSDV) approach was used. However, I really think a codebook is needed to address how these variables are dummy coded).
  
> Concerns: some '88' and '99' value under the column of Del2d and Del2e. Still not really sure what they meant. They are separate from NA.

```{r histograms of selected variables}
hist(GangEpl[5:6]) #Histograms of EmployHrs and WmployWg
hist(GangEpl[7:12]) #Histograms of Del1a to Del1f
hist(GangEpl[13:18]) #Histograms of Del2a to Del2f
hist(GangEpl[19]) #Histograms of Del3
hist(GangEpl[20]) #Histograms of Del4
hist(GangEpl[21:26]) #Histograms of Del5a to Del5f
hist(GangEpl[27:30]) #Histograms of GangInv1 to GangInv4 
```

## Scale Scores Computation

Compute the average scale scores for each scale (Del1, Del2, Del5, GangInv, GangMem):

[ML]: # (I'm not sure whether an unweighted average of the item scores is the way to go, as the items have different)

[ML]: # (From the paper, it was stated that 'the gang activityw responses were dichotomized to '0' (i.e., never in this group, no longer in a gang, or not active in a gang) and '1' (i.e., rarely active, very active, or gang leader)', which should be the GangInv2 variable.)

```{r Computing Scale Score}
GangEpl <- GangEpl %>% 
  mutate(Del1 = (Del1a + Del1b + Del1c + Del1d + Del1e + Del1f) / 6, 
         Del2 = (Del2a + Del2b + Del2c + Del2d + Del2e + Del2f) / 6,
         Del5 = (Del5a + Del5b + Del5c + Del5d + Del5e + Del5f) / 6,
         GangInv = (GangInv1 + GangInv2 + GangInv3 + GangInv4) / 4,
         GangMem = (GangMem1 + GangMem2 + GangMem3 + GangMem4 + GangMem5 + GangMem6 + GangMem7 + GangMem8 + GangMem9 + GangMem10 + GangMem11 + GangMem12 + GangMem13 + GangMem14 + GangMem5) / 15)
```

# Data Visualization (Spaghettie Plots and Individual Trajectories)

```{r}
GangEpl %>% 
    select(ID, Session, Date, EmployHrs, EmployWg) %>% 
    psych::pairs.panels(jiggle = TRUE, factor = 0.5, ellipses = FALSE, 
                        cex.cor = 1, cex = 0.5)
```

[ML]: # (You can use a second-level heading)

## Spaghetti Plots

```{r EmployHrs ~ Date}
pEmployHrs <- ggplot(GangEpl, aes(x = Date, y = EmployHrs)) + 
  geom_point() + 
  geom_line(aes(group = ID, color = factor(ID)))   # add lines to connect the data for each person
pEmployHrs #The time variable is Date
```

[ML]: # (I added the following)

```{r EmployHrs ~ elapse}
GangEpl %>% 
    group_by(ID) %>% 
    mutate(elapse = Date - min(Date)) %>% 
ggplot(aes(x = elapse, y = EmployHrs)) + 
  geom_point() + 
  geom_line(aes(group = ID, color = factor(ID))) + 
  labs(x = "Days since first measurement")
```

According to the plot above, we can see that all participants only participated in a certain period within three years (i.e. Participant ID 2 stayed in the program for only 4 months). The length of period and the number of sessions they participated were different from each other. Most of participants did not get employed every week so there were a lot of 0 points in the plot, and this is why the plot looks fluctuating heavily. The attribute of this plot applies to all other dependent variables, with date as the explanatory variable.

```{r EmployWg ~ Date}
pEmployWg <- ggplot(GangEpl, aes(x = Date, y = EmployWg)) + 
  geom_point() + 
  geom_line(aes(group = ID, color = factor(ID)))  # add lines to connect the data for each person
  # add a mean trajectory
pEmployWg #The time variable is Date
```

This is a plot illustrating the employ wage of previous week. The highest number of 120.

```{r spaghetti plot}
pDel1 <- ggplot(GangEpl, aes(x = Date, y = Del1)) + 
  geom_point() + 
  geom_line(aes(group = ID)) +  # add lines to connect the data for each person
  # add a mean trajectory
  geom_line(aes(group = ID, color = factor(ID)))
pDel1

pDel2 <- ggplot(GangEpl, aes(x = Date, y = Del2)) + 
  geom_point() + 
  geom_line(aes(group = ID)) +  # add lines to connect the data for each person
  # add a mean trajectory
  geom_line(aes(group = ID, color = factor(ID)))
pDel2

pDel3 <- ggplot(GangEpl, aes(x = Date, y = Del3)) + 
  geom_point() + 
  geom_line(aes(group = ID)) +  # add lines to connect the data for each person
  # add a mean trajectory
  geom_line(aes(group = ID, color = factor(ID)))
pDel3

pDel4 <- ggplot(GangEpl, aes(x = Date, y = Del4)) + 
  geom_point() + 
  geom_line(aes(group = ID)) +  # add lines to connect the data for each person
  # add a mean trajectory
  geom_line(aes(group = ID, color = factor(ID)))
pDel4

pDel5 <- ggplot(GangEpl, aes(x = Date, y = Del5)) + 
  geom_point() + 
  geom_line(aes(group = ID)) +  # add lines to connect the data for each person
  # add a mean trajectory
  geom_line(aes(group = ID, color = factor(ID)))
pDel5

pGangInv <- ggplot(GangEpl, aes(x = Date, y = GangInv)) + 
  geom_point() + 
  geom_line(aes(group = ID)) +  # add lines to connect the data for each person
  # add a mean trajectory
  geom_line(aes(group = ID, color = factor(ID)))
pGangInv

pGangMem <- ggplot(GangEpl, aes(x = Date, y = GangMem)) + 
  geom_point() + 
  geom_line(aes(group = ID)) +  # add lines to connect the data for each person
  # add a mean trajectory
  geom_line(aes(group = ID, color = factor(ID)))
pGangMem
```

Notes: The missing part of the plots means that the data is missing (N/A).

## Individual Trajectories of EmployHrs and EmployWg:

```{r Individual Trajectories}
GangEpl %>% 
  ggplot(aes(x = Date)) + 
  geom_line(aes(y = EmployHrs), col = "blue") + 
  geom_line(aes(y = EmployWg), col = "red") + 
  facet_wrap( ~ ID, ncol = 4)
```

This is an illustration of individual trajectories of EmployHrs and EmployWg for each participant. We can see that there are serious data missing issue with participant 2, 10, 13, 26, and 27. 

# Random Intercept Model and Intraclass Correlation

```{r random Intercep Model of EmployHrs, cache = TRUE, results = 'hide'}
ran_int_EmployHrs <- brm(EmployHrs ~ (1 | ID), data = GangEpl, 
                         seed = 2152)
```

```{r results_EmployHrs}
summary(ran_int_EmployHrs)

post_samples <- posterior_samples(ran_int_EmployHrs, pars = c("sd", "sigma"))
# Posterior of ICC: tau_0^2 / (tau_0^2 + sigma^2)
icc_samples_EmployHrs <- post_samples$sd_ID__Intercept^2 / 
  (post_samples$sd_ID__Intercept^2 + post_samples$sigma^2)
c(EmployHrs = mean(icc_samples_EmployHrs))
```

A random intercept model was run for calculating intraclass correlation, with EmployHrs as the outcome variable. The ICC for EmployHrs is 0.39 meaning that the proportion of variance explained by the cluster of ID (per participants) is about 39%. It is fairly high to continue analyzing the data using MLM.

```{r random Intercep Model of EmployWg, cache=TRUE, results='hide'}
ran_int_EmployWg <- brm(EmployWg ~ (1 | ID), data = GangEpl, 
                        seed = 2152)
```

```{r result_EmployWg, cache=TRUE, echo=FALSE}
summary(ran_int_EmployWg)

post_samples <- posterior_samples(ran_int_EmployWg, pars = c("sd", "sigma"))
# Posterior of ICC: tau_0^2 / (tau_0^2 + sigma^2)
icc_samples_EmployWg <- post_samples$sd_ID__Intercept^2 / 
  (post_samples$sd_ID__Intercept^2 + post_samples$sigma^2)
c(EmployWg = mean(icc_samples_EmployWg))
```

The ICC of EmloyWg is only 4.4%, much lower than EmployHrs. 

[ML]: # (Please replace the following analyses with `GangInv`)

```{r random Intercep Model of GangInv, cache=TRUE, results='hide', eval = FALSE}
ran_int_GangInv <- brm(GangInv ~ (1 | ID), data = GangEpl, 
               seed = 2152)
```

```{r result_GangInv, cache=TRUE, eval = FALSE}
summary(ran_int_GangInv)

post_samples <- posterior_samples(ran_int_GangInv, pars = c("sd", "sigma"))
# Posterior of ICC: tau_0^2 / (tau_0^2 + sigma^2)
icc_samples_GangInv <- post_samples$sd_ID__Intercept^2 / 
  (post_samples$sd_ID__Intercept^2 + post_samples$sigma^2)
c(GangInv = mean(icc_samples_GangInv))
```

<!-- The ICC of GangInv is really high, 72.6%. -->

[ML]: # (The data is highly skewed. Maybe try a binomial logistic instead.)

```{r random Intercep Model of GangMem, cache=TRUE, results='hide'}
ran_int_GangMem <- brm(GangMem ~ (1 | ID), data = GangEpl, 
               seed = 2152)
```

```{r result_GangMem}
summary(ran_int_GangMem)

post_samples <- posterior_samples(ran_int_GangMem, pars = c("sd", "sigma"))
# Posterior of ICC: tau_0^2 / (tau_0^2 + sigma^2)
icc_samples_GangMem <- post_samples$sd_ID__Intercept^2 / 
  (post_samples$sd_ID__Intercept^2 + post_samples$sigma^2)
c(GangMem = mean(icc_samples_GangMem))
```

The ICC of GangInv is also kind of high, 40.8%.

## Checking whether there is a trend in the data

```{r trend checking, echo=FALSE, cache=TRUE, results='hide'}
m_Trend <- brm(EmployHrs ~ Date + (Date | ID), data = GangEpl, 
          seed = 2313, 
          control = list(adapt_delta = .90))
```

```{r result_m_Trend, echo=FALSE, cache=TRUE}
summary(m_Trend)
```

[ML]: # (What do you mean by 'convergent' below?)

Since the outcome of this model is not convergent with a pretty small coefficient of date, we can say that there is a negligible trend in te data.

# Adding variables

First, let me decompose the between-within effects by computing the mean-centered variables for each predicting variables with their means.

```{r centering variables, cache=TRUE, echo=FALSE, results='hide'}
GangEpl <- GangEpl %>% 
  group_by(ID) %>% 
  mutate(across(c(Del1, Del2, Del3, Del4, Del5, GangInv, GangMem), 
                # The `.` means the variable to be operated on
                list("pm" = ~ mean(., na.rm = TRUE), 
                     "pmc" = ~ . - mean(., na.rm = TRUE)))) %>% 
  ungroup()
GangEpl
```

[ML]: # (I think the paper is about Gang activity/involvement/membership as outcome. Please modify the analyses and interpretations, and centering choices.)

# Using variables to predict EmployHrs

```{r between-within effects, cache=TRUE, results='hide', eval=FALSE}
m_EmployHrs <- brm(EmployHrs ~ GangInv_pm + GangInv_pmc + GangMem_pm + GangMem_pmc + Del1_pm + Del1_pmc + Del2_pm + Del2_pmc + Del3_pm + Del3_pmc + Del4_pm + Del4_pmc + Del5_pm + Del5_pmc + (GangInv_pmc + GangMem_pmc + Del1_pmc + Del2_pmc + Del3_pmc + Del4_pmc + Del5_pmc | ID), data = GangEpl, seed = 2152)
```

```{r results_m_EmployHrs, eval=FALSE}
summary(m_EmployHrs)
```

Model Equations:

Lv-1:

$$\text{EmployHrs}_{ij} = \beta_{0j} + \beta_{1j} \text{GangInv\_pmc}_{ij} + \beta_{2j} \text{GangMem\_pmc}_{ij} + \beta_{3j} \text{Del1\_pmc}_{ij} + \beta_{4j} \text{Del2\_pmc}_{ij} + \beta_{5j} \text{Del3\_pmc}_{ij} + \beta_{6j} \text{Del4\_pmc}_{ij} + \beta_{7j} \text{Del5\_pmc}_{ij} + e_{ij}$$
Lv-2:

$$
\begin{aligned}
  \beta_{0j} & = \gamma_{00} + \gamma_{01} \text{GangInv\_pm}_j + \gamma_{02} \text{GangMem\_pm}_j + \gamma_{03} \text{Del1\_pm}_j + \gamma_{04} \text{Del2\_pm}_j + \gamma_{05} \text{Del3\_pm}_j + \gamma_{06} \text{Del4\_pm}_j + \gamma_{07} \text{Del5\_pm}_j + u_{0j}  \\
  \beta_{1j} & = \gamma_{10}+ u_{1j} \\
  \beta_{2j} & = \gamma_{20}+ u_{2j} \\
  \beta_{3j} & = \gamma_{30}+ u_{3j} \\
  \beta_{4j} & = \gamma_{40}+ u_{4j} \\
  \beta_{5j} & = \gamma_{50}+ u_{5j} \\
  \beta_{6j} & = \gamma_{60}+ u_{6j} \\
  \beta_{7j} & = \gamma_{70}+ u_{7j} \\
\end{aligned}
$$

<!-- Interpretation of the model results: -->

<!-- It seems that GangInv_pm, GangMem_pm, Del4_pm and Del5_pm are significantly predicting the employment hours. The random effects of these four variables are also significant.  -->

## Coefficient Table

Here is a coefficient table for the trend model and EmployHrs model:

```{r, eval = FALSE}
msummary_mixed(list("Trend" = m_Trend, 
                    "NA --> PA" = m_EmployHrs), 
               statistic = "conf.int", 
               looic = TRUE)
```

## Visualizing the Data

```{r, eval = FALSE}
GangEpl %>% 
  filter(ID %in% sample(unique(ID), 12)) %>% 
ggplot(aes(x = GangInv, y = EmployHrs)) + 
  geom_point(size = 0.5) + 
  geom_smooth(method = "lm") + 
  facet_wrap( ~ ID)
```

Here is an illustration of random effects of gang involvement on employment hours. 



